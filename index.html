<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copyright Â© 2003-2022 shan</title>
    <script src=" https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.js"></script>

    <!-- https://blog.csdn.net/qq_52940025/article/details/128133104 -->
    <!-- <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.47/vue.global.prod.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/docxtemplater/3.31.2/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip-utils.js"></script>
    <link rel="stylesheet" href="./mycss.css">
</head>

<!-- é«˜è®¾ç¬¬3ç‰ˆP349 -->

<body ondragenter='event.preventDefault()' ondragover='event.preventDefault()'>
    <div class="loading">
        <div class="loading-square"></div>
        <div class="loading-square"></div>
        <div class="loading-square"></div>
        <div class="loading-square"></div>
    </div>

    <!-- https://juejin.cn/post/7020064738956705823 -->
    <div class="spinner">
        <div class="outer">
            <div class="inner tl"></div>
            <div class="inner tr"></div>
            <div class="inner br"></div>
            <div class="inner bl"></div>
        </div>
    </div>

    <div class="gradient-border" id="box">
        <p>å—é€šä¸­ç­‰ä¸“ä¸šå­¦æ ¡å­¦ç”Ÿå­¦ç±è¡¨è‡ªåŠ¨ç”Ÿæˆå·¥å…·1.0ç‰ˆ</p>
    </div>

    <div id="app">
        <div>
            <p style="color:red;font-weight:bold;">ç¬¬ä¸€æ­¥: è®¾ç½®å¿…è¦ä¿¡æ¯</p>
            <p>é‡‡ç”¨é«˜èŒç­å­¦ç±è¡¨æ¨¡æ¿æˆ–ä¸­èŒç­å­¦ç±è¡¨æ¨¡æ¿: </p>
            <p>--é«˜èŒç­å­¦ç±è¡¨æ¨¡æ¿--æ‰“
                <span :style="{color:pick==='high'?'red':'green',fontWeight:'bold'}">âˆš</span>
                <input type="radio" v-model="pick" value="high" />
            </p>
            <p>--ä¸­èŒç­å­¦ç±è¡¨æ¨¡æ¿--æ‰“
                <span :style="{color:pick==='low'?'red':'yellowgreen',fontWeight:'bold'}">âˆš</span>
                <input type="radio" v-model="pick" value="low" />
            </p>
        </div>

        <div>
            <p style="color:red;font-weight:bold;">ç¬¬äºŒæ­¥: æ— éœ€æ‰‹åŠ¨æ•´åˆ,é€‰æ‹©ç›¸å…³Excelè¡¨æ ¼æ‰€åœ¨æ–‡ä»¶å¤¹ æˆ–è€… ç›´æ¥æ‹–å…¥ç›¸å…³Excelè¡¨æ ¼</p>
            <label class="my_label" @change='handleFile'>
                <!-- https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#attr-accept -->
                <!-- https://juejin.cn/post/7063110398945280013 -->
                <input type="file" hidden multiple accept=".xlsx,.xls" webkitdirectory />
                ç‚¹å‡»é€‰å–å­¦æœŸæˆç»©æ€»è¡¨ã€å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨ã€5ä¸ªæˆ–3ä¸ªå­¦å¹´çš„è¯„è¯­è¡¨æ‰€åœ¨çš„æ–‡ä»¶å¤¹
            </label>
            <p id="droptarget" @drop='handleFile'>
                æ‹–å…¥å­¦æœŸæˆç»©æ€»è¡¨ã€<br>
                å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨ã€<br>
                5ä¸ªæˆ–3ä¸ªå­¦å¹´çš„è¯„è¯­è¡¨<br>
            </p>
        </div>

        <div>
            <p style="color:red;font-weight:bold;">ç¬¬ä¸‰æ­¥: å…ˆç‚¹å‡»è·å–æ•´åˆæ•°æ®,å†ç‚¹å‡»å¼€å§‹åˆ¶ä½œ</p>

            <!-- https://cn.vuejs.org/guide/essentials/conditional.html#v-if-vs-v-show -->
            <div v-if='JSON.stringify(courseNameObj) !== "{}"'>
                <p style="color:green;">
                    å¦‚æœéœ€è¦æ‰“å°,è¯·ç‚¹å‡»æ˜¾ç¤º,æŠŠä¸‹åˆ—è¯¾ç¨‹åç§°ä¿®æ”¹åˆ°ä¸è¶…è¿‡10ä¸ªå­—çš„èŒƒå›´:
                    <button @click="value = value==='none'?'block' : 'none'">æ˜¾ç¤º/éšè—</button>
                </p>
                <!-- https://zhuanlan.zhihu.com/p/368014069?utm_id=0 -->
                <!-- https://cn.vuejs.org/style-guide/rules-essential.html#avoid-v-if-with-v-for -->
                <!-- <div id='show' style='visibility:hidden'> -->
                <!-- https://cn.vuejs.org/guide/essentials/class-and-style.html#binding-inline-styles -->
                <div :style="{display:value}">
                    <ul>
                        <!-- https://cn.vuejs.org/guide/essentials/list.html#v-for-with-an-object -->
                        <template v-for="value,name in courseNameObj" :key="name">
                            <li v-if="name.length>10">
                                {{ name }}<input v-model='courseNameObj[name]'></input>
                            </li>
                        </template>
                    </ul>
                </div>
                <button @click="handle">ä¿å­˜ä¿®æ”¹</button>
            </div>

            <span
                style="color:white;font: 20px bold;"
                v-if="messages&&(n<=messages.length-1)">å½“å‰å®Œæˆè¿›åº¦: {{ n===-1 ? 0 : Math.floor(100*n/(messages.length-1)) }}%
            </span>
            <span
                style="color:yellowgreen;font: 20px bold;"
                v-if="messages&&(n>=messages.length-1)">
                å·²ç»å…¨éƒ¨å®Œæˆå•¦~~~~~~åšæŸå…‰ç…§äº®ä½ æ¸©æš–ä½ ~ä¸ºæ‚¨èŠ‚çœä¸‹æ¥çš„æ¯ä¸€ç§’éƒ½ä¼šä½¿æˆ‘å¿«ä¹!
            </span>
            <!-- è¿›åº¦æ¡ -->
            <div class="g-container"
                v-if="messages&&(n<=messages.length-1)">
                <div
                    class="g-progress"
                    :style="`width:${225*(n+1)/messages.length}px`">
                </div>
            </div>
            <p style="color:#0f0">{{info}}</p>
            <button @click="fetchMessages" class="my_label">è·å–æ•´åˆæ•°æ®</button>&nbsp
            <button @click="initiate" class="my_label">å¼€å§‹åˆ¶ä½œ</button>
            <!-- <button @click="generate(messages[0])" class="my_label">å¼€å§‹åˆ¶ä½œ</button> -->
        </div>
    </div>

    <div class="card">
        <h1>å±±å¤–ç‹‚é£åˆèµ·ï¼Œå¿ƒé—´å£®å¿—éš¾å¹³ã€‚</h1>
        <h1>ä»—å‰‘äº‘å³°è¿æ—¥è½ï¼Œç­–é©¬å¹³å·é€æœˆæœ—ã€‚å¤©æ¶¯ä»»æˆ‘è¡Œã€‚</h1>
        <h1>è‡ªå¤ä¹¾å¤æ˜“å˜ï¼Œä»æ¥èƒœè´¥æ— å‡­ã€‚</h1>
<!--         <h1>ä½†å¾—æµ®ç”Ÿè¯—é…’è¶£ï¼Œè«é—®æ±Ÿæ¹–å„¿å¥³æƒ…ã€‚ä½•é¡»å§“ä¸åã€‚</h1> -->
<!--         <h4>2023 / 03 / 30</h4> -->
    </div>
    <div class="circle"></div>
    <div class="rect"></div>

    <p style="color:gold">Copyright Â© 2003-2022 shanchen All Rights Reserved. ç‰ˆæœ¬å·:1.0</p>
</body>

<script>
    const app = Vue.createApp({
        data() {
            return {
                messages: '', //å­˜å‚¨æ•´åˆæ•°æ®
                courseNameObj: {},
                courseNames_required: [],
                courseNames_no_required: [],

                n: -1,//ç”¨æ¥è¡¨ç¤ºmessagesç´¢å¼•
                timer: 0,//è¿›åº¦æ¡
                pick: 'high',
                value: 'none',//æ§åˆ¶ä¿®æ”¹è¯¾ç¨‹åç§°æ˜¾ç¤ºä¸éšè—
                //é¢å¤–æ•°æ®
                addInfo: {},
                info: 'ğŸ‘‡ğŸ»å…ˆç‚¹å‡»æ£€æŸ¥æ•´åˆæ•°æ®,å†ç‚¹å‡»å¼€å§‹åˆ¶ä½œ',
            }
        },

        methods: {
            handleFile(e) {
                // console.log(e.type)
                let files
                if (e.type === 'drop') {
                    e.stopPropagation()
                    //https://www.jianshu.com/p/6e921d7680ac
                    //chromeæµè§ˆå™¨çš„dropäº‹ä»¶çš„é»˜è®¤è¡Œä¸ºæ˜¯æ‰“å¼€è¢«æ”¾åˆ°æ”¾ç½®ç›®æ ‡ä¸Šçš„URLã€‚ä¸ºäº†è®©chromeæ”¯æŒæ­£å¸¸çš„æ‹–æ”¾ï¼Œè¿˜è¦å–æ¶ˆdropäº‹ä»¶çš„é»˜è®¤è¡Œä¸º
                    e.preventDefault()
                    files = e.dataTransfer.files
                } else if (e.type === 'change') {
                    files = e.target.files
                }
                // console.log(files)
                // debugger

                let file8, file9, file10, file11, file12, file13, file14
                for (let i = 0; i < files.length; i++) {
                    const type = files[i].name.split('.')

                    //å…¼å®¹360æµè§ˆå™¨
                    //æ ¡éªŒæ‹–å…¥æ–‡ä»¶æ˜¯å¦åˆæ³•
                    // if (type[1] !== 'xlsx' && type[1] !== 'xls') {
                    //     alert('åªèƒ½é€‰æ‹©åç¼€åæ˜¯xlsxæˆ–è€…xlsçš„Excelæ–‡ä»¶æ‹–å…¥')
                    //     return
                    // }
                    if (type[0].includes('å­¦æœŸæˆç»©æ€»è¡¨')) {
                        file8 = files[i]
                    } else if (type[0].includes('å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨')) {
                        file9 = files[i]
                    } else if (type[0].includes('ç¬¬ä¸€å­¦å¹´è¯„è¯­')) {
                        file10 = files[i]
                    } else if (type[0].includes('ç¬¬äºŒå­¦å¹´è¯„è¯­')) {
                        file11 = files[i]
                    } else if (type[0].includes('ç¬¬ä¸‰å­¦å¹´è¯„è¯­')) {
                        file12 = files[i]
                    } else if (type[0].includes('ç¬¬å››å­¦å¹´è¯„è¯­')) {
                        file13 = files[i]
                    } else if (type[0].includes('ç¬¬äº”å­¦å¹´è¯„è¯­')) {
                        file14 = files[i]
                    }
                }

                function getExcelPlus(file, unPlus = true) {
                    return new Promise(function (resolve, reject) {
                        const reader = new FileReader()
                        //https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsBinaryString
                        reader.readAsArrayBuffer(file)
                        reader.onload = function (e) {
                            let fdata = e.target.result
                            fdata = new Uint8Array(fdata)

                            const workbook = XLSX.read(fdata, {type: 'array'})

                            const SheetNames = workbook.SheetNames
                            const worksheet = workbook.Sheets[SheetNames[0]]

                            //https://blog.csdn.net/weixin_43817709/article/details/103754546
                            const sheetOptions = {
                                /** Default value for null/undefined values */
                                defval: '', //ç»™defvalèµ‹å€¼ä¸ºç©ºçš„å­—ç¬¦ä¸²
                            }

                            const data = XLSX.utils.sheet_to_json(worksheet, sheetOptions)
                            if (unPlus) {
                                resolve(data)
                            } else {
                                //å¤„ç†æˆç»©file1
                                // console.log(data)
                                // debugger
                                data.shift()//å»æ‰ç¬¬ä¸€è¡Œæ ‡é¢˜è¡Œ
                                const headers = [
                                    'å­¦ç”Ÿæˆç»©è¡¨',//å­¦å¹´
                                    '__EMPTY',//å­¦æœŸ
                                    // '__EMPTY_1',//å­¦é™¢
                                    // '__EMPTY_2',//ä¸“ä¸š
                                    // '__EMPTY_3',//å¹´çº§
                                    // '__EMPTY_4',//ç­çº§
                                    // '__EMPTY_5',//å­¦åˆ¶
                                    // '__EMPTY_6',//å­¦å·
                                    '__EMPTY_7',//å§“å
                                    // '__EMPTY_8',//è¯¾ç¨‹ä»£ç 
                                    '__EMPTY_9',//è¯¾ç¨‹åç§°
                                    '__EMPTY_10',//è¯¾ç¨‹æ€§è´¨
                                    // '__EMPTY_13',//æœŸä¸­æˆç»©
                                    // '__EMPTY_15',//æœŸæœ«æˆç»©
                                    '__EMPTY_12',//å­¦æœŸæˆç»©
                                    '__EMPTY_11',//å­¦åˆ†
                                    // '__EMPTY_16',//å®è·µæˆç»©
                                ]
                                //å°†dataä¸­çš„æ¯ä¸€é¡¹(å¯¹è±¡)æŒ‰headersçš„é¡ºåºè½¬å˜æˆæ•°ç»„
                                let aoa = data.map(obj => headers.map(head => obj[head]))
                                // console.log(aoa)
                                // console.log(aoa[0])
                                // console.log(aoa[0][8])//å­¦ç”Ÿå§“å
                                // debugger
                                //åˆå¹¶å§“åç›¸åŒçš„å­¦ç”Ÿæˆç»©ä¿¡æ¯
                                aoa = aoa.map(arr => arr.map(item => item.replaceAll(' ', '')))//å»ç©ºæ ¼
                                const res = aoa.reduce((prev, next) => {
                                    let index = prev.findIndex(elem => {
                                        return next[2] === elem[0][2]
                                    })
                                    if (index === -1) {
                                        prev.push([next])
                                    } else {
                                        prev[index].push(next)
                                    }
                                    return prev
                                }, [])
                                resolve(res)
                            }
                        }
                    })
                }

                if (file8 && file9 && file10 && file11 && file12) {
                    const promise8 = getExcelPlus(file8, false)//å­¦æœŸæˆç»©æ€»è¡¨
                    const promise9 = getExcelPlus(file9)//å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨
                    const promise10 = getExcelPlus(file10)//ç¬¬ä¸€å­¦å¹´è¯„è¯­
                    const promise11 = getExcelPlus(file11)//ç¬¬äºŒå­¦å¹´è¯„è¯­
                    const promise12 = getExcelPlus(file12)//ç¬¬ä¸‰å­¦å¹´è¯„è¯­
                    // let promise13, promise14
                    // if (this.pick === 'high') {
                    //     promise13 = getExcelPlus(file13)//ç¬¬å››å­¦å¹´è¯„è¯­
                    //     promise14 = getExcelPlus(file14)//ç¬¬äº”å­¦å¹´è¯„è¯­
                    // }
                    const promise13 = getExcelPlus(file13)//ç¬¬å››å­¦å¹´è¯„è¯­
                    const promise14 = getExcelPlus(file14)//ç¬¬äº”å­¦å¹´è¯„è¯­
                    Promise.allSettled(
                        [promise8, promise9,
                            promise10, promise11, promise12, promise13, promise14]
                    ).then(v => {
                        // console.log(v)
                        // debugger
                        // console.log(v[0].status)//æˆåŠŸè¿”å›'fulfilled' å¤±è´¥è¿”å›'rejected'

                        //å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨
                        // console.log(v[1].value)
                        //tempç”¨æ¥æŒ‰ç…§å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨çš„å§“åé¡ºåºæ”¶é›†æ‰€éœ€æ•°æ®
                        const temp = []
                        v[1].value.forEach((obj, index) => {
                            temp[index] = {å§“å: obj.å§“å, å­¦å·: obj.å­¦å·, å­¦å¹´è¯„è¯­: {}}
                        })
                        // console.log(temp)
                        // debugger

                        //å¤„ç†å­¦å¹´è¯„è¯­
                        // console.log(v[2].value)
                        // debugger
                        const v23456 = [v[2], v[3], v[4], v[5], v[6]].map(elem => elem.value)
                        // console.log(v23456)
                        // debugger
                        temp.forEach(obj1 => {
                            v23456.forEach((v, i) => {
                                //ä¸­èŒæƒ…å†µä¸‹v[5]ã€v[6]æ˜¯undefined,æ‰€ä»¥åŠ å¯é€‰é“¾?
                                v?.forEach(obj2 => {
                                    //å¢è¡¥å­¦ç”Ÿåå•ä¼šå‡ºç°å•å…ƒæ ¼çš„æ•°å­—å¯¼å‡ºå­—ç¬¦ä¸²çš„é—®é¢˜,æ‰€ä»¥ä½¿ç”¨åŒç­‰å·è¾¾åˆ°éšå¼ç±»å‹è½¬æ¢
                                    if (obj1.å­¦å· == obj2.å­¦å·) {
                                        obj1.å­¦å¹´è¯„è¯­[`ç¬¬${i + 1}å­¦å¹´è¯„è¯­`] = obj2.è¯„å®šè¯„è¯­
                                        obj1.å­¦å¹´è¯„è¯­[`ç¬¬${i + 1}å­¦å¹´æ“è¡Œ`] = obj2.æ“è¡Œç­‰ç¬¬
                                        obj1.å­¦å¹´è¯„è¯­.ç­ä¸»ä»» ??= obj2.ç­ä¸»ä»»
                                    }
                                })
                            })
                        })
                        // console.log(temp)
                        // debugger

                        //å¤„ç†å­¦æœŸæˆç»©æ€»è¡¨
                        const end = new Date().getFullYear()
                        // const end = 2024
                        const schoolYear = []
                        let i = this.pick === 'high' ? 5 : 3
                        while (i >= 1) {
                            schoolYear.push(
                                `${end - i}-${end - (i - 1)}_1`,
                                `${end - i}-${end - (i - 1)}_2`,
                            )
                            i--
                        }
                        // console.log(schoolYear)
                        // debugger
                        // console.log(v[0].value)
                        // debugger
                        //å°†æ¯ä¸ªäººçš„10ä¸ªå­¦æœŸçš„æˆç»©æ•°ç»„arræŒ‰å­¦æœŸé¡ºåºåˆ†ç±»
                        let v0 = v[0].value.map(arr => {
                            const result = this.pick === 'high'
                                ? [[], [], [], [], [], [], [], [], [], []]
                                : [[], [], [], [], [], []]
                            let index
                            arr.forEach(item => {
                                index = schoolYear.indexOf(`${item[0]}_${item[1]}`)
                                result[index].push(item)
                            })
                            return result
                        })
                        // console.log(v0)
                        // debugger
                        //å¯¹æ¯ä¸ªäººæ¯å­¦æœŸçš„è¯¾ç¨‹æ’åº
                        v0.forEach(res => {
                            res.forEach(item => {
                                item.sort((a, b) => a[3].localeCompare(b[3]))
                            })
                        })
                        // console.log(v0[0])
                        // console.log(v0[1])
                        // debugger

                        //åˆ é™¤æ²¡æœ‰æˆç»©æˆ–å­¦åˆ†çš„è¯¾ç¨‹,åˆ é™¤åŒä¸€å­¦æœŸåŒåè¯¾ç¨‹å¹¶å–åˆ†æ•°é«˜çš„
                        let courseNames_required = new Set()
                        let courseNames_no_required = new Set()
                        v0.forEach(res => {
                            // console.log(res)//resæ˜¯æŸäººæŒ‰å­¦æœŸé¡ºåºåˆ†ç±»çš„10ä¸ªå­¦æœŸçš„æˆç»©
                            // debugger
                            res.forEach(item => {
                                // console.log(item)//itemæ˜¯æŸäºº1ä¸ªå­¦æœŸçš„æˆç»©
                                // debugger
                                const temp = new Set()
                                for (let i = 0; i < item.length; i++) {
                                    const v = item[i]
                                    // console.log(v)//['2021-2022', '1', 'æ¨ä½³ç¾', 'é’¢ç´åŸºç¡€', 'å¿…ä¿®è¯¾', '64', '2']
                                    // debugger
                                    if (v[4] === 'å¿…ä¿®è¯¾') {
                                        courseNames_required.add(v[3])
                                    } else {
                                        courseNames_no_required.add(v[3])
                                    }

                                    if (+v[5] === 0 && +v[6] === 0) {//åˆ é™¤æ²¡æœ‰æˆç»©æˆ–å­¦åˆ†çš„è¯¾ç¨‹
                                        item.splice(i, 1)
                                        i--
                                    } else if (temp.has(v[3])) {//åˆ é™¤åŒä¸€å­¦æœŸåŒåè¯¾ç¨‹å¹¶å–åˆ†æ•°é«˜çš„
                                        if (i > 0 && v[5] > item[i - 1][5]) {
                                            item[i - 1][5] = v[5]
                                            item[i - 1][6] = v[6]
                                        }
                                        item.splice(i, 1)
                                        i--
                                    } else {
                                        temp.add(v[3])
                                    }
                                }
                            })
                        })

                        this.courseNames_required = [...courseNames_required]
                        this.courseNames_no_required = [...courseNames_no_required]
                        // console.log(this.courseNames_required)
                        // console.log(this.courseNames_no_required)
                        // debugger
                        let courseNames = [...courseNames_required, ...courseNames_no_required]
                        for (const value of courseNames) {
                            this.courseNameObj[value] = value
                        }
                        temp.forEach(obj => {
                            v0.forEach(arr => {
                                if (arr.some(elem => elem.some(ele => ele.includes(obj.å§“å)))) {
                                    obj.å­¦æœŸæˆç»©æ€»è¡¨ = arr
                                }
                            })
                        })
                        // console.log(temp)
                        // debugger

                        // console.log(v[1].value)
                        // debugger
                        //å°†tempæ±‡æ€»çš„æ•°æ®äº¤ç»™å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨
                        v[1].value.forEach(obj1 => {
                            temp.forEach(obj2 => {
                                if (obj1.å­¦å· == obj2.å­¦å·) {
                                    obj1.å­¦å¹´è¯„è¯­ = obj2.å­¦å¹´è¯„è¯­
                                    obj1.å­¦æœŸæˆç»©æ€»è¡¨ = obj2.å­¦æœŸæˆç»©æ€»è¡¨
                                    //å¤„ç†ä¸­èŒç­æ¨¡æ¿ä¸­å‡ ä¸ªæ—¶é—´
                                    if (this.pick === 'low') {
                                        obj1.å…¥å­¦æ—¶é—´ = `${end - 3}å¹´6æœˆ30æ—¥`
                                        obj1.æ¯•ä¸šæ—¶é—´ = `${end}å¹´6æœˆ30æ—¥`
                                        obj1.ä¸ªäººç®€å†1 = `${end - 3}å¹´6æœˆ~${end}å¹´6æœˆ`
                                        obj1.ä¸ªäººç®€å†2 = `${end - 6}å¹´6æœˆ~${end - 3}å¹´6æœˆ`
                                        obj1.å­¦å¹´1 = `${end - 3}/${end - 2}`
                                        obj1.æŠ¥åˆ°1 = `${end - 3}å¹´9æœˆ7æ—¥`
                                        obj1.æŠ¥åˆ°2 = `${end - 2}å¹´1æœˆ14æ—¥`
                                        obj1.å­¦å¹´2 = `${end - 2}/${end - 1}`
                                        obj1.æŠ¥åˆ°3 = `${end - 2}å¹´9æœˆ7æ—¥`
                                        obj1.æŠ¥åˆ°4 = `${end - 1}å¹´1æœˆ14æ—¥`
                                        obj1.å­¦å¹´3 = `${end - 1}/${end}`
                                        obj1.æŠ¥åˆ°5 = `${end - 1}å¹´9æœˆ7æ—¥`
                                        obj1.æŠ¥åˆ°6 = `${end}å¹´1æœˆ14æ—¥`
                                    }
                                }
                            })
                        })
                        // console.log(v[1].value)
                        // debugger
                        this.messages = v[1].value
                        // localStorage.setItem('messages', JSON.stringify(v[1].value))
                        // sessionStorage.setItem('messages', JSON.stringify(v[1].value))
                    })
                    return
                }

                if (this.pick === 'high' && !(file8 && file9 && file10 && file11 && file12 && file13 && file14)) {
                    alert(`å¦‚æœæ‚¨æƒ³åˆ¶ä½œé«˜èŒå­¦ç±è¡¨,è¯·ä¸Šä¼ å¿…éœ€çš„å­¦æœŸæˆç»©æ€»è¡¨ã€å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨ã€5ä¸ªå­¦å¹´çš„è¯„è¯­è¡¨`)
                    return
                }
                if (this.pick === 'low' && !(file8 && file9 && file10 && file11 && file12)) {
                    alert(`å¦‚æœæ‚¨æƒ³åˆ¶ä½œä¸­èŒå­¦ç±è¡¨,è¯·ä¸Šä¼ å¿…éœ€çš„å­¦æœŸæˆç»©æ€»è¡¨ã€å­¦ç±ä¿¡æ¯æ”¶é›†è¡¨ã€3ä¸ªå­¦å¹´çš„è¯„è¯­è¡¨`)
                    return
                }
            },

            //è·å–ç›¸å…³æ•´åˆæ•°æ®
            fetchMessages() {
                // this.messages = JSON.parse(localStorage.getItem('messages'))
                // this.messages = JSON.parse(sessionStorage.getItem('messages'))
                console.log(this.messages[0])
                // console.log(this.messages[0].å­¦æœŸæˆç»©æ€»è¡¨)
                // debugger
                if (sessionStorage.getItem('courseNameObj2')) {
                    this.courseNameObj = JSON.parse(sessionStorage.getItem('courseNameObj2'))
                }
                // console.log(this.courseNameObj)
                // console.log(this.courseNames_required)
                // console.log(this.courseNames_no_required)
                this.info =
                    this.messages ? ' à¥‚(ÊšÌ´Ì¶Ì·Ì .Ì  ÊšÌ´Ì¶Ì·Ì¥Ì€ à¥‚)è·å–æ•´åˆæ•°æ®æˆåŠŸ~'
                        : '(â•¯>Ğ´<)â•¯â½Ë™Â³Ë™â¾è·å–æ•´åˆæ•°æ®å¤±è´¥,è¯·å›åˆ°ç¬¬ä¸€æ­¥é€‰å–æˆ–è€…æ‹–å…¥ç›¸å…³Excelè¡¨'
                // show.style.visibility = 'visible'
                // show.style.display = 'block'
            },
            handle() {
                //https://cn.vuejs.org/api/reactivity-advanced.html#toraw
                sessionStorage.setItem('courseNameObj2', JSON.stringify(Vue.toRaw(this.courseNameObj)))
                this.value = this.value === 'block' ? 'none' : 'block'
            },
            //å¼€å…³
            initiate() {
                if (!this.messages) {
                    alert(`è¯·å…ˆè·å–æ•´åˆæ•°æ®`)
                    return
                }
                this.timer = setInterval(() => {
                    if (this.n <= this.messages.length - 1) this.n++
                    else clearInterval(this.timer)//this.nç­‰äºthis.messages.length-1æ—¶æœ€åä¸€æ¬¡è‡ªå¢
                }, 200)
            },
            generate(msg) {
                // console.log(msg)
                const str = this.pick === 'high' ? "high.docx" : "low.docx"
                const courseNameObj = this.courseNameObj
                const courseNames_required = this.courseNames_required
                const courseNames_no_required = this.courseNames_no_required
                const pick = this.pick
                PizZipUtils.getBinaryContent(str, function (error, content) {
                    // console.log(this.courseNameObj)//å›è°ƒå‡½æ•°å†…éƒ¨è®¿é—®ä¸åˆ°this
                    //æŠ›å‡ºè¯»å–é”™è¯¯
                    if (error) {throw error}

                    const zip = new PizZip(content)
                    //https://docxtemplater.com/docs/configuration/#paragraphloop
                    //https://docxtemplater.com/docs/configuration/#linebreaks
                    const doc = new docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        //https://juejin.cn/post/7094139413248081928
                        nullGetter: function () {
                            return ""
                        }
                    })

                    //å¤„ç†å­¦æœŸæˆç»©æ€»è¡¨
                    const temp = msg.å­¦æœŸæˆç»©æ€»è¡¨//æŸäººçš„10ä¸ªå­¦æœŸæˆç»©
                    // console.log(temp)
                    // debugger
                    const record = {}
                    if (pick === 'high') {
                        temp?.forEach((semester, index) => {//å´å¤§å¸…æ²¡æœ‰è€ƒè¯•æˆç»©
                            semester.forEach((v, i) => {
                                record[`course${index + 1}_${i + 1}`]
                                    = v[3].length <= 10 ? v[3] : courseNameObj[v[3]]//è¯¾ç¨‹åç§°
                                record[`k${index + 1}_${i + 1}`] =
                                    v[4] === 'å¿…ä¿®è¯¾' ? 'å¿…ä¿®'
                                        : v[4] === 'å®ä¹ å®è®­è¯¾' ? 'å®è®­'
                                            : v[4] === 'é€šä¿®è¯¾' ? 'é€šä¿®' : ''//ç±»åˆ«

                                //v[5]æ˜¯ä¸ªå­—ç¬¦ä¸²,å¯èƒ½æ˜¯'96.69'ã€'67'ã€'56/68'
                                // record[`r${index + 1}_${i + 1}`] = Math.round(v[5]) || ''//æˆç»©,æœ‰å‡ºç°å°æ•°å‰²è£‚è¡¨æ ¼çš„æƒ…å†µæ‰€ä»¥å–æ•´
                                const it = v[5].indexOf('/')//i=-1 ~i=0
                                record[`r${index + 1}_${i + 1}`] = Math.round(~it ? v[5].slice(it + 1) : v[5]) || ''
                                record[`c${index + 1}_${i + 1}`] = v[6] || ''//å­¦åˆ†
                            })
                        })
                    } else {
                        courseNames_required.sort((a, b) => a.localeCompare(b))
                        for (let i = 1; i <= 28; i++) {
                            record[`course${i}`] = courseNames_required[i - 1] || ''
                        }
                        courseNames_no_required.sort((a, b) => a.localeCompare(b))
                        for (let i = 29; i <= 34; i++) {
                            record[`course${i}`] = courseNames_no_required[i - 29] || ''
                        }
                        const courseNames = [...courseNames_required, ...courseNames_no_required]
                        // console.log(courseNames)
                        // console.log(record)
                        // debugger
                        temp?.forEach((semester, index) => {//å´å¤§å¸…æ²¡æœ‰è€ƒè¯•æˆç»©
                            semester.forEach(v => {
                                //væ˜¯è¿™æ ·æ»´['2021-2022', '1', 'æ¨ä½³ç¾', 'é’¢ç´åŸºç¡€', 'å¿…ä¿®è¯¾', '64', '2']
                                const j = courseNames.indexOf(v[3])
                                //v[5]æ˜¯ä¸ªå­—ç¬¦ä¸²,å¯èƒ½æ˜¯'96.69'ã€'67'ã€'56/68'
                                //æˆç»©,æœ‰å‡ºç°å°æ•°å‰²è£‚è¡¨æ ¼çš„æƒ…å†µæ‰€ä»¥å–æ•´
                                const it = v[5].indexOf('/')//i=-1 ~i=0
                                // record[`k${index + 1}_${j + 1}`] = ~j ? Math.round(~it ? v[5].slice(it + 1) : v[5]) : ''
                                let temp
                                if (j !== -1) {
                                    if (it !== -1) {
                                        // temp = Math.round(~it ? v[5].slice(it + 1) : v[5])
                                        temp = Math.round(v[5].slice(it + 1))
                                    } else if (Number.isNaN(+v[5])) {
                                        temp = v[5]
                                    } else {
                                        temp = Math.round(v[5])
                                    }
                                } else {
                                    temp = ''
                                }
                                record[`k${index + 1}_${j + 1}`] = temp
                            })
                        })
                        // console.log(record)
                        // debugger
                    }
                    // console.log(record)
                    // debugger

                    //è¦å¡«å……çš„æ•°æ®
                    doc.setData({
                        ...msg,
                        grade: msg.ç­çº§åç§°.slice(0, 2),
                        class: msg.ç­çº§åç§°.slice(0, 4),
                        year: new Date().getFullYear(),//'20' + (+msg.ç­çº§åç§°.slice(0, 2) + 5)

                        ...msg.å­¦å¹´è¯„è¯­,

                        ...record,
                    })
                    try {
                        doc.render()
                    }
                    catch (error) {
                        //https://docxtemplater.com/docs/errors/#handling-multiple-errors
                        //https://juejin.cn/post/7026337152044630047
                        let e = {
                            message: error.message,
                            name: error.name,
                            stack: error.stack,
                            properties: error.properties
                        };
                        console.log(JSON.stringify({error: e}))
                        throw error
                    }

                    var out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        //https://docxtemplater.com/docs/faq/#generate-smaller-docx-using-compression
                        compression: "DEFLATE",
                    })

                    //https://www.hangge.com/blog/cache/detail_1795.html
                    //éœ€è¦è‡ªå·±è®¾ç½®å¥½æµè§ˆå™¨ä¿å­˜æ–‡ä»¶çš„ä½ç½®
                    saveAs(out, `${msg.ç­çº§åç§°}-${msg.å­¦å·}-${msg.å§“å}.docx`)
                })
            },
        },

        watch: {
            n(newValue) {
                if (this.n === this.messages.length) {
                    alert(`ä¸ºæ‚¨èŠ‚çœä¸‹æ¥çš„æ¯ä¸€ç§’éƒ½ä¼šä½¿æˆ‘å¿«ä¹!`)
                    return
                }
                const message = this.messages[newValue]
                this.generate(message)
            },
            pick: {
                handler: function (newValue, oldValue) {
                    console.log(this.pick)
                    console.log(window.devicePixelRatio)
                    if (window.devicePixelRatio != 1.5) {
                        document.body.style.zoom = 1.5
                    }
                },
                immediate: true,
            },
            // courseNameObj: {
            //     handler: function (newValue, oldValue) {
            //         // console.log(newValue === oldValue)//true
            //         // console.log(newValue.x)
            //         console.log(newValue)
            //     },
            //     immediate: true,
            //     //https://cn.vuejs.org/guide/essentials/watchers.html#deep-watchers
            //     deep: true,
            // }
        }
    })

    const vm = app.mount('#app')
</script>

</html>
